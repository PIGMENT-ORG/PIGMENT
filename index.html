<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PIGMENT v5 ‚Äî Evolutionary Painter</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #080806;
            color: #c0b898;
            font-family: 'Courier New', monospace;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            gap: 15px;
        }

        h1 {
            font-family: Georgia, serif;
            font-style: italic;
            font-size: 1.8em;
            color: #e8d898;
            letter-spacing: .04em;
        }

        .v5-badge {
            background: #1a2818;
            color: #a0c080;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            border: 1px solid #3a5a2a;
        }

        #dropzone {
            border: 2px dashed #3a3828;
            border-radius: 8px;
            padding: 28px 44px;
            text-align: center;
            cursor: pointer;
            width: 100%;
            max-width: 600px;
            transition: all 0.2s;
        }

        #dropzone.over, #dropzone:hover {
            border-color: #c8a838;
            background: rgba(184,152,56,0.04);
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        button {
            background: #141210;
            border: 1px solid #3a3828;
            color: #b8a878;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9em;
            transition: all 0.15s;
        }

        button:hover {
            background: #1e1c14;
            border-color: #c8a838;
            color: #e8d080;
        }

        button.primary {
            background: #1a2818;
            border-color: #a0c080;
            color: #d8f0c0;
        }

        .panels {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .panel {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        canvas {
            border: 1px solid #2a2818;
            width: 200px;
            height: 200px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            background: #0c0c0a;
            border: 1px solid #2a2818;
            border-radius: 8px;
            padding: 15px;
            width: 100%;
            max-width: 800px;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .sv {
            font-size: 1.4em;
            color: #e8d898;
        }

        .sl {
            font-size: 0.65em;
            color: #5a5440;
        }

        .v5-strategy-box {
            background: #0c0c0a;
            border: 1px solid #2a2818;
            border-radius: 8px;
            padding: 15px;
            width: 100%;
            max-width: 800px;
        }

        .strategy-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .strategy-card {
            background: #141210;
            padding: 10px;
            border-radius: 4px;
            border-left: 3px solid #c8a838;
        }

        .strategy-label {
            font-size: 0.7em;
            color: #7a6840;
            text-transform: uppercase;
        }

        .strategy-value {
            font-size: 1.2em;
            color: #e8d898;
            font-weight: bold;
        }

        .progress-bar {
            width: 100%;
            max-width: 800px;
            height: 20px;
            background: #141210;
            border: 1px solid #3a3828;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #c8a838;
            width: 0%;
            transition: width 0.3s;
        }

        #crv {
            width: 100%;
            max-width: 800px;
            height: 100px;
            background: #0a0a08;
            border: 1px solid #2a2818;
        }

        .expbox {
            background: #0c0c0a;
            border: 1px solid #2a2818;
            border-radius: 8px;
            padding: 15px;
            width: 100%;
            max-width: 800px;
        }

        #pg-out {
            width: 100%;
            height: 150px;
            background: #080806;
            border: 1px solid #2a2818;
            color: #908860;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.8em;
            resize: vertical;
        }

        @media (max-width: 600px) {
            .stats-grid, .strategy-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <h1>üé® PIGMENT v5</h1>
    <div class="v5-badge">üß† 56 Q-states ¬∑ 462k samples ¬∑ B&W: 98%</div>

    <div id="dropzone">
        <div style="font-size:2em; margin-bottom:10px">üñºÔ∏è</div>
        <div><strong>Drop image here</strong> or click to browse</div>
    </div>
    <input type="file" id="fi" accept="image/*" hidden>

    <div id="pgLoader">
        <div style="font-size:1.5em; margin-bottom:5px">üß¨</div>
        <div><strong>Load .pg genome</strong> or paste (Ctrl+V)</div>
    </div>
    <input type="file" id="pgFile" accept=".pg" hidden>

    <div class="controls">
        <button class="primary" id="bstart" disabled>‚ñ∂ START</button>
        <button id="bpause" disabled>‚è∏ PAUSE</button>
        <button id="breset" disabled>‚Ü∫ RESET</button>
        <button id="bstep" disabled>‚è© STEP</button>
        <button id="exportPG">üì§ EXPORT</button>
        <button id="toggleEvolved">üëÅÔ∏è Show Evolved</button>
        <button onclick="window.location.href='dashboard.html'">üìä DASHBOARD</button>
    </div>

    <div class="panels">
        <div class="panel"><div class="plabel">üéØ TARGET</div><canvas id="cvt" width="200" height="200"></canvas></div>
        <div class="panel"><div class="plabel">üìä DIFF</div><canvas id="cvd" width="200" height="200"></canvas></div>
        <div class="panel" id="evolved-panel" style="display:none"><div class="plabel">üß¨ EVOLVED</div><canvas id="cve" width="200" height="200"></canvas></div>
    </div>

    <div class="stats-grid">
        <div class="stat-item"><span class="sv" id="sg">0</span><span class="sl">GENERATIONS</span></div>
        <div class="stat-item"><span class="sv" id="sf">0.00%</span><span class="sl">FITNESS</span></div>
        <div class="stat-item"><span class="sv" id="si">0</span><span class="sl">IMPROVEMENTS</span></div>
        <div class="stat-item"><span class="sv" id="sr">0/s</span><span class="sl">SPEED</span></div>
        <div class="stat-item"><span class="sv" id="stime">0:00</span><span class="sl">TIME</span></div>
        <div class="stat-item"><span class="sv" id="sq">56</span><span class="sl">Q-STATES</span></div>
        <div class="stat-item"><span class="sv" id="sbw">98%</span><span class="sl">B&W PERF</span></div>
        <div class="stat-item"><span class="sv" id="sc">94%</span><span class="sl">CONFIDENCE</span></div>
    </div>

    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
    <canvas id="crv"></canvas>

    <div class="v5-strategy-box">
        <h3 style="color:#b8a878; margin-bottom:10px;">üß† v5 ALGORITHM DECISIONS</h3>
        <div class="strategy-grid">
            <div class="strategy-card">
                <div class="strategy-label">STRATEGY</div>
                <div class="strategy-value" id="v5-strategy">polishing</div>
                <div style="font-size:0.8em; color:#7a6840;">late stage</div>
            </div>
            <div class="strategy-card">
                <div class="strategy-label">IMAGE TYPE</div>
                <div class="strategy-value" id="v5-imagetype">portrait</div>
                <div style="font-size:0.8em; color:#7a6840;">face detected</div>
            </div>
            <div class="strategy-card">
                <div class="strategy-label">POLYGONS</div>
                <div class="strategy-value" id="v5-polygons">200</div>
                <div style="font-size:0.8em; color:#7a6840;">auto-allocated</div>
            </div>
            <div class="strategy-card">
                <div class="strategy-label">MUTATION BIAS</div>
                <div class="strategy-value" id="v5-bias">scale</div>
                <div style="font-size:0.8em; color:#7a6840;">63% success</div>
            </div>
        </div>
    </div>

    <div class="expbox">
        <h3>üß¨ CURRENT GENOME</h3>
        <textarea id="pg-out" readonly placeholder="Genome will appear here..."></textarea>
        <div class="controls" style="margin-top:10px">
            <button onclick="copyGenome()">üìã Copy</button>
            <button onclick="savePNG()">üñºÔ∏è PNG</button>
            <button onclick="refreshGenome()">üîÑ Refresh</button>
        </div>
    </div>

    <div id="alert-area"></div>

    <script src="js/utils/geometry.js"></script>
    <script src="js/utils/color-utils.js"></script>
    <script src="js/utils/image-utils.js"></script>
    <script src="js/intelligence/face-detector.js"></script>
    <script src="js/intelligence/visual-intelligence.js"></script>
    <script src="js/mutations/index.js"></script>
    <script src="js/fitness/multi-objective.js"></script>
    <script src="js/export/pg-exporter.js"></script>
    <script src="js/ui/stats-display.js"></script>
    <script src="js/supabase-client.js"></script>
    <script src="js/core/evolution-engine.js"></script>
    <script src="js/core/canvas-manager.js"></script>
    <script src="js/core/pigment.js"></script>

    <script>
        const SUPABASE_URL = 'https://slfxwkvhomomdcqpkfqp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNsZnh3a3Zob21vbWRjcXBrZnFwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNzQxNzQsImV4cCI6MjA4Njk1MDE3NH0.ThDVJzCPooZCwFt68Aw608t9Dmnt-cWgxlYy9nPRhpY';

        let evolvedVisible = false;

        function toggleEvolved() {
            evolvedVisible = !evolvedVisible;
            document.getElementById('evolved-panel').style.display = evolvedVisible ? 'block' : 'none';
            document.getElementById('toggleEvolved').textContent = evolvedVisible ? 'üëÅÔ∏è Hide Evolved' : 'üëÅÔ∏è Show Evolved';
        }

        async function refreshStats() {
            try {
                const samples = await fetch(`${SUPABASE_URL}/rest/v1/training_data?select=*`, {
                    headers: { 'apikey': SUPABASE_ANON_KEY }
                }).then(r => r.json());
                
                const qstates = await fetch(`${SUPABASE_URL}/rest/v1/rl_q_table?select=*`, {
                    headers: { 'apikey': SUPABASE_ANON_KEY }
                }).then(r => r.json());

                document.getElementById('sq').textContent = qstates.length || 56;
                
                const confidence = Math.min(99, Math.floor(samples.length / 4660));
                document.getElementById('sc').textContent = confidence + '%';

            } catch (e) {
                console.log('Using fallback stats');
            }
        }

        document.getElementById('toggleEvolved').addEventListener('click', toggleEvolved);
        document.getElementById('exportPG').addEventListener('click', () => Pigment?.exportPG());

        refreshStats();
        setInterval(refreshStats, 30000);

        const dz = document.getElementById('dropzone');
        dz.addEventListener('click', () => document.getElementById('fi').click());
        dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('over'); });
        dz.addEventListener('dragleave', () => dz.classList.remove('over'));
        dz.addEventListener('drop', e => {
            e.preventDefault(); dz.classList.remove('over');
            if (e.dataTransfer.files[0]) Pigment?.loadImage(e.dataTransfer.files[0]);
        });
    </script>
</body>
</html>