<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PIGMENT â€” Evolutionary Painter</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{background:#080806;color:#c0b898;font-family:'Courier New',monospace;
             min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:20px;gap:14px}
        h1{font-family:Georgia,serif;font-style:italic;font-size:1.55em;color:#e8d898;letter-spacing:.04em}
        .sub{font-size:.7em;color:#44402e;letter-spacing:.08em}
        #dropzone{border:2px dashed #3a3828;border-radius:8px;padding:28px 44px;text-align:center;
          cursor:pointer;color:#5a5440;font-size:.83em;transition:all .2s}
        #dropzone.over,#dropzone:hover{border-color:#b89838;color:#d8c878;background:rgba(184,152,56,.04)}
        .controls{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;align-items:center}
        button{background:#141210;border:1px solid #3a3828;color:#b8a878;padding:6px 16px;
          border-radius:4px;cursor:pointer;font-family:inherit;font-size:.8em;letter-spacing:.04em;transition:all .15s}
        button:hover{background:#1e1c14;border-color:#7a6830;color:#d8c878}
        button:disabled{opacity:.35;cursor:not-allowed}
        button.go{background:#1a1808;border-color:#c8a838;color:#e8d080}
        button.go:hover{background:#242010}
        select,input[type=range]{background:#141210;border:1px solid #3a3828;color:#b8a878;
          padding:5px 8px;border-radius:4px;font-family:inherit;font-size:.78em}
        label{font-size:.76em;color:#5a5440;display:flex;align-items:center;gap:6px}
        .panels{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
        .panel{display:flex;flex-direction:column;align-items:center;gap:5px}
        .plabel{font-size:.65em;color:#3a3828;letter-spacing:.09em;text-transform:uppercase}
        canvas.view{border:1px solid #1e1c14;image-rendering:pixelated;image-rendering:crisp-edges}
        .stats{display:flex;gap:20px;flex-wrap:wrap;justify-content:center;font-size:.76em;color:#7a7460}
        .sv{font-size:1.28em;color:#c0b080;font-family:Georgia,serif}
        .sl{font-size:.67em;color:#3a3828;letter-spacing:.06em}
        #crv{background:#0a0a08;border:1px solid #1e1c14;border-radius:3px;width:460px;max-width:96vw;height:72px}
        .expbox{background:#0c0c0a;border:1px solid #1e1c14;border-radius:6px;padding:12px 16px;width:460px;max-width:96vw}
        .expbox h3{font-family:Georgia,serif;font-size:.85em;color:#7a6840;margin-bottom:8px;letter-spacing:.04em}
        #pg-out{width:100%;height:150px;background:#080806;border:1px solid #181612;color:#908860;
          font-family:'Courier New',monospace;font-size:.7em;padding:8px;resize:vertical;outline:none}
        .row{display:flex;gap:8px;margin-top:8px}
        
        /* New dashboard button */
        .dashboard-link {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #141210;
            border: 1px solid #c8a838;
            color: #e8d080;
            padding: 8px 16px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 0.8em;
            z-index: 1000;
        }
        .dashboard-link:hover {
            background: #242010;
        }
    </style>
</head>
<body>
    <a href="dashboard.html" class="dashboard-link">ğŸ“Š DASHBOARD</a>
    <a href="training.html" class="dashboard-link" style="right: 140px;">ğŸ“¦ TRAINING</a>

    <h1>PIGMENT â€” Evolutionary Painter</h1>
    <div class="sub">ROGER ALSING HILL-CLIMBING Â· PIGMENT V3 Â· SEMI-TRANSPARENT POLYGON GENOME</div>

    <div id="dropzone" onclick="document.getElementById('fi').click()">
        <div style="font-size:1.6em;margin-bottom:6px">ğŸ¨</div>
        <div>Drop target image or click to choose</div>
    </div>
    <input type="file" id="fi" accept="image/*" style="display:none">

    <div class="controls">
        <button class="go" id="bstart" disabled onclick="doStart()">â–¶ Start</button>
        <button id="bpause" disabled onclick="doPause()">â¸ Pause</button>
        <button id="breset" disabled onclick="doReset()">â†º Reset</button>
        <span style="width:1px;height:22px;background:#1e1c14"></span>
        <label>Polygons
            <select id="selpoly"><option value="50" selected>50</option><option value="100">100</option><option value="150">150</option><option value="200">200</option></select>
        </label>
        <label>Speed
            <select id="selspd"><option value="10">Slow (10)</option><option value="30" selected>Normal (30)</option><option value="80">Fast (80)</option><option value="200">Max (200)</option></select>
        </label>
        <label>Max size <input type="range" id="rsize" min="2" max="9" step=".5" value="4" style="width:80px"></label>
    </div>

    <div class="panels">
        <div class="panel"><div class="plabel">Target</div><canvas class="view" id="cvt"></canvas></div>
        <div class="panel"><div class="plabel">Evolved</div><canvas class="view" id="cve"></canvas></div>
        <div class="panel"><div class="plabel">Diff Ã—4</div><canvas class="view" id="cvd"></canvas></div>
    </div>

    <div class="stats">
        <div><div class="sv" id="sg">0</div><div class="sl">Generation</div></div>
        <div><div class="sv" id="sf">0.00%</div><div class="sl">Fitness</div></div>
        <div><div class="sv" id="si">0</div><div class="sl">Improvements</div></div>
        <div><div class="sv" id="sr">0/s</div><div class="sl">Mut/sec</div></div>
        <div><div class="sv" id="sm">1.00</div><div class="sl">Mut rate</div></div>
    </div>

    <canvas id="crv"></canvas>

    <div class="expbox">
        <h3>PIGMENT Genome Export</h3>
        <textarea id="pg-out" readonly placeholder="Evolve first â€” genome will appear as PIGMENT .pg source..."></textarea>
        <div class="row">
            <button onclick="doExport()">â†“ Export .pg</button>
            <button onclick="doCopy()">Copy</button>
            <button onclick="doSaveImg()">Save PNG</button>
            <button onclick="document.getElementById('pg-out').value=genPG()">Refresh</button>
        </div>
    </div>

    <script>
        // â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const BASE_W=200, BASE_H=300;
        let W=BASE_W, H=BASE_H;
        let targetPx=null;
        let polys=[], bestPolys=[], bestErr=Infinity;
        let running=false, paused=false;
        let gen=0, impr=0, mutRate=1.0;
        let rateT={n:0,t:performance.now()};
        let fitHist=[];
        let raf=null;

        const cvWork=document.createElement('canvas');
        const ctxWork=cvWork.getContext('2d');
        const cvT=document.getElementById('cvt'),ctxT=cvT.getContext('2d');
        const cvE=document.getElementById('cve'),ctxE=cvE.getContext('2d');
        const cvD=document.getElementById('cvd'),ctxD=cvD.getContext('2d');
        const crv=document.getElementById('crv'),crvCtx=crv.getContext('2d');
        const DS=2; // display scale

        // â”€â”€ Image loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function loadFile(f){
            const r=new FileReader();
            r.onload=e=>loadURL(e.target.result);
            r.readAsDataURL(f);
        }
        
        function loadURL(url){
            const img=new Image();
            img.onload=()=>{
                const ratio=img.height/img.width;
                W=BASE_W; H=Math.max(40,Math.round(W*ratio));
                if(H>360){H=360;W=Math.round(H/ratio);}
                cvWork.width=W;cvWork.height=H;
                ctxWork.drawImage(img,0,0,W,H);
                targetPx=new Uint8ClampedArray(ctxWork.getImageData(0,0,W,H).data);
                const dw=W*DS,dh=H*DS;
                [cvT,cvE,cvD].forEach(c=>{c.width=dw;c.height=dh;});
                ctxT.drawImage(cvWork,0,0,dw,dh);
                document.getElementById('dropzone').style.display='none';
                document.getElementById('bstart').disabled=false;
                document.getElementById('breset').disabled=false;
                doReset();
            };
            img.src=url;
        }

        // â”€â”€ Genome â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function rPoly(){
            const sz=W*(0.05+Math.random()*parseFloat(document.getElementById('rsize').value)*0.06);
            const cx=Math.random()*W, cy=Math.random()*H;
            const pts=[];
            for(let i=0;i<3;i++){
                const a=(i/3)*Math.PI*2+Math.random()*1.2;
                const r=sz*(0.4+Math.random()*0.9);
                pts.push([cx+Math.cos(a)*r,cy+Math.sin(a)*r]);
            }
            return{pts,r:Math.random()*255|0,g:Math.random()*255|0,b:Math.random()*255|0,a:(20+Math.random()*100)|0};
        }
        
        function clp(x,y){
            return[Math.max(-W*.1,Math.min(W*1.1,x)),Math.max(-H*.1,Math.min(H*1.1,y))];
        }
        
        function gauss(s){
            const u1=Math.random(),u2=Math.random();
            return s*Math.sqrt(-2*Math.log(u1+1e-9))*Math.cos(2*Math.PI*u2);
        }

        function mutPoly(p,mr){
            const q={pts:p.pts.map(pt=>[...pt]),r:p.r,g:p.g,b:p.b,a:p.a};
            const c=Math.random();
            if(c<0.28){
                const vi=Math.random()*q.pts.length|0;
                const s=W*0.05*mr;
                q.pts[vi]=clp(q.pts[vi][0]+gauss(s),q.pts[vi][1]+gauss(s));
            }
            else if(c<0.46){
                const dx=gauss(W*.04*mr),dy=gauss(H*.04*mr);
                q.pts=q.pts.map(([x,y])=>clp(x+dx,y+dy));
            }
            else if(c<0.62){
                const ch=['r','g','b'][Math.random()*3|0];
                q[ch]=Math.max(0,Math.min(255,q[ch]+gauss(18*mr)|0));
            }
            else if(c<0.78){
                q.a=Math.max(6,Math.min(165,q.a+gauss(10*mr)|0));
            }
            else if(c<0.90){
                const sc=0.82+Math.random()*0.40;
                const cx=q.pts.reduce((s,p)=>s+p[0],0)/q.pts.length;
                const cy=q.pts.reduce((s,p)=>s+p[1],0)/q.pts.length;
                q.pts=q.pts.map(([x,y])=>clp(cx+(x-cx)*sc,cy+(y-cy)*sc));
            }
            else return rPoly();
            return q;
        }

        // â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function render(ps,ctx,w,h){
            ctx.clearRect(0,0,w,h);
            ctx.fillStyle='#fff';
            ctx.fillRect(0,0,w,h);
            for(const p of ps){
                ctx.beginPath();
                ctx.moveTo(p.pts[0][0],p.pts[0][1]);
                for(let i=1;i<p.pts.length;i++)ctx.lineTo(p.pts[i][0],p.pts[i][1]);
                ctx.closePath();
                ctx.fillStyle=`rgba(${p.r},${p.g},${p.b},${p.a/255})`;
                ctx.fill();
            }
        }

        // â”€â”€ Fitness â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function calcErr(id){
            const d=id.data,t=targetPx;
            let e=0;
            for(let i=0;i<d.length;i+=4){
                const dr=d[i]-t[i];
                const dg=d[i+1]-t[i+1];
                const db=d[i+2]-t[i+2];
                e+=dr*dr+dg*dg+db*db;
            }
            return e;
        }
        
        function fitPct(e){
            return Math.max(0,100*(1-e/(255*255*3*W*H)));
        }

        // â”€â”€ Evolution â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function evolveStep(){
            const pc=parseInt(document.getElementById('selpoly').value);
            const sp=parseInt(document.getElementById('selspd').value);
            for(let s=0;s<sp;s++){
                const idx=Math.random()*polys.length|0;
                const candidate=polys.slice();
                candidate[idx]=mutPoly(polys[idx],mutRate);
                cvWork.width=W;cvWork.height=H;
                render(candidate,ctxWork,W,H);
                const err=calcErr(ctxWork.getImageData(0,0,W,H));
                if(err<bestErr){
                    polys=candidate;
                    bestPolys=candidate.map(p=>({...p,pts:p.pts.map(pt=>[...pt])}));
                    bestErr=err;
                    impr++;
                    mutRate=Math.max(0.18,mutRate*0.9999);
                }else{
                    mutRate=Math.min(2.2,mutRate*1.00005);
                }
                gen++;
                rateT.n++;
            }
            if(polys.length<pc && gen%900===0){
                polys.push(rPoly());
                bestPolys=polys.map(p=>({...p,pts:p.pts.map(pt=>[...pt])}));
            }
        }

        let fc=0;
        
        function frame(){
            if(!running||paused){raf=null;return;}
            evolveStep();
            fc++;
            if(fc%4===0)updateDisplay();
            raf=requestAnimationFrame(frame);
        }

        function updateDisplay(){
            cvWork.width=W;cvWork.height=H;
            render(bestPolys,ctxWork,W,H);
            const dw=W*DS,dh=H*DS;
            ctxE.drawImage(cvWork,0,0,dw,dh);
            
            // Diff
            const ev=ctxWork.getImageData(0,0,W,H);
            const diff=ctxD.createImageData(W,H);
            for(let i=0;i<ev.data.length;i+=4){
                diff.data[i]=Math.min(255,Math.abs(ev.data[i]-targetPx[i])*4);
                diff.data[i+1]=Math.min(255,Math.abs(ev.data[i+1]-targetPx[i+1])*4);
                diff.data[i+2]=Math.min(255,Math.abs(ev.data[i+2]-targetPx[i+2])*4);
                diff.data[i+3]=255;
            }
            const tmp=document.createElement('canvas');
            tmp.width=W;
            tmp.height=H;
            tmp.getContext('2d').putImageData(diff,0,0);
            ctxD.drawImage(tmp,0,0,dw,dh);
            
            // Stats
            const fp=fitPct(bestErr);
            document.getElementById('sg').textContent=gen.toLocaleString();
            document.getElementById('sf').textContent=fp.toFixed(2)+'%';
            document.getElementById('si').textContent=impr.toLocaleString();
            document.getElementById('sm').textContent=mutRate.toFixed(3);
            
            const now=performance.now(),dt=(now-rateT.t)/1000;
            if(dt>0.5){
                document.getElementById('sr').textContent=(rateT.n/dt|0)+'/s';
                rateT={n:0,t:now};
            }
            
            fitHist.push(fp);
            if(fitHist.length>300)fitHist.shift();
            drawCurve();
            
            if(impr>0&&impr%3000===0)document.getElementById('pg-out').value=genPG();
        }

        function drawCurve(){
            const cw=crv.width,ch=crv.height;
            crvCtx.clearRect(0,0,cw,ch);
            if(fitHist.length<2)return;
            const mx=Math.max(...fitHist),mn=Math.min(...fitHist),rng=Math.max(mx-mn,0.5);
            crvCtx.strokeStyle='#c0a030';
            crvCtx.lineWidth=1.5;
            crvCtx.beginPath();
            for(let i=0;i<fitHist.length;i++){
                const x=(i/(fitHist.length-1))*cw;
                const y=ch-((fitHist[i]-mn)/rng)*(ch-4)-2;
                i===0?crvCtx.moveTo(x,y):crvCtx.lineTo(x,y);
            }
            crvCtx.stroke();
            crvCtx.fillStyle='#3a3828';
            crvCtx.font='10px Courier New';
            crvCtx.fillText(mx.toFixed(1)+'%',4,11);
            crvCtx.fillText(mn.toFixed(1)+'%',4,ch-3);
        }

        // â”€â”€ Controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function doStart(){
            if(!targetPx)return;
            running=true;
            paused=false;
            document.getElementById('bstart').disabled=true;
            document.getElementById('bpause').disabled=false;
            if(!raf)raf=requestAnimationFrame(frame);
        }
        
        function doPause(){
            paused=!paused;
            document.getElementById('bpause').textContent=paused?'â–¶ Resume':'â¸ Pause';
            if(!paused&&!raf)raf=requestAnimationFrame(frame);
        }
        
        function doReset(){
            if(raf){
                cancelAnimationFrame(raf);
                raf=null;
            }
            running=false;
            paused=false;
            
            const pc=parseInt(document.getElementById('selpoly').value);
            polys=Array.from({length:pc},()=>rPoly());
            bestPolys=polys.map(p=>({...p,pts:p.pts.map(pt=>[...pt])}));
            
            cvWork.width=W;
            cvWork.height=H;
            render(bestPolys,ctxWork,W,H);
            bestErr=calcErr(ctxWork.getImageData(0,0,W,H));
            
            gen=0;
            impr=0;
            mutRate=1.0;
            fitHist=[];
            rateT={n:0,t:performance.now()};
            
            document.getElementById('bstart').disabled=false;
            document.getElementById('bpause').disabled=true;
            document.getElementById('bpause').textContent='â¸ Pause';
            document.getElementById('pg-out').value='';
            
            updateDisplay();
        }

        // â”€â”€ Genome export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function genPG(){
            const fp=fitPct(bestErr);
            const lines=[
                `-- PIGMENT v3 Evolutionary Genome`,
                `-- Gen: ${gen.toLocaleString()}  Fitness: ${fp.toFixed(2)}%  Polygons: ${bestPolys.length}`,
                `-- Algorithm: Roger Alsing hill-climbing mutation`,``,
                `canvas { format: portrait  title: "Evolved Painting"  artist: "PIGMENT v3 Evolutionary Engine"  date: "${new Date().getFullYear()}" }`,``,
                `palette {`,
            ];
            const step=Math.max(1,bestPolys.length/16|0);
            const palNames=[];
            for(let i=0;i<bestPolys.length;i+=step){
                const p=bestPolys[i];
                const h=p.r.toString(16).padStart(2,'0')+p.g.toString(16).padStart(2,'0')+p.b.toString(16).padStart(2,'0');
                const nm=`p${palNames.length}`;
                palNames.push(nm);
                lines.push(`  ${nm.padEnd(8)}: #${h}`);
            }
            lines.push(`}`,'',`layer evolved {`);
            for(let i=0;i<bestPolys.length;i++){
                const p=bestPolys[i];
                const h=p.r.toString(16).padStart(2,'0')+p.g.toString(16).padStart(2,'0')+p.b.toString(16).padStart(2,'0');
                const op=(p.a/255).toFixed(3);
                const pts=p.pts.map(([x,y])=>`${(x/W).toFixed(3)},${(y/H).toFixed(3)}`).join(' ');
                lines.push(`  -- [${pts}]  Î±=${op}`);
                lines.push(`  zone poly-${i} { color: #${h}  opacity: ${op} }`);
            }
            lines.push(`}`);
            return lines.join('\n');
        }
        
        function doExport(){
            const t=genPG();
            const a=document.createElement('a');
            a.href=URL.createObjectURL(new Blob([t],{type:'text/plain'}));
            a.download=`evolved_gen${gen}.pg`;
            a.click();
            document.getElementById('pg-out').value=t;
        }
        
        function doCopy(){
            navigator.clipboard.writeText(genPG()).catch(()=>{});
            document.getElementById('pg-out').value=genPG();
        }
        
        function doSaveImg(){
            cvWork.width=W*4;
            cvWork.height=H*4;
            render(bestPolys,ctxWork,W*4,H*4);
            const a=document.createElement('a');
            a.href=cvWork.toDataURL('image/png');
            a.download=`evolved_gen${gen}.png`;
            a.click();
        }

        // â”€â”€ File drop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        document.getElementById('fi').onchange=e=>{if(e.target.files[0])loadFile(e.target.files[0]);};
        
        const dz=document.getElementById('dropzone');
        dz.addEventListener('dragover',e=>{
            e.preventDefault();
            dz.classList.add('over');
        });
        
        dz.addEventListener('dragleave',()=>dz.classList.remove('over'));
        
        dz.addEventListener('drop',e=>{
            e.preventDefault();
            dz.classList.remove('over');
            const f=e.dataTransfer.files[0];
            if(f&&f.type.startsWith('image/'))loadFile(f);
        });

        // Curve resize
        function rCrv(){
            crv.width=document.getElementById('crv').parentElement.clientWidth||460;
            crv.height=72;
        }
        
        rCrv();
        window.addEventListener('resize',rCrv);
    </script>
</body>
</html>