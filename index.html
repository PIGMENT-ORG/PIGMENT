<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>PIGMENT ‚Äî Evolutionary Painter</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #080806;
            color: #c0b898;
            font-family: 'Courier New', monospace;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            gap: 15px;
        }

        h1 {
            font-family: Georgia, serif;
            font-style: italic;
            font-size: clamp(1.3em, 5vw, 1.8em);
            color: #e8d898;
            letter-spacing: .04em;
            text-align: center;
        }

        .sub {
            font-size: clamp(0.6em, 3vw, 0.8em);
            color: #5a5440;
            letter-spacing: .08em;
            text-align: center;
        }

        /* Dashboard Link - Only Link */
        .dashboard-link {
            position: fixed;
            top: 15px;
            right: 15px;
            background: #1a2818;
            border: 1px solid #a0c080;
            color: #d8f0c0;
            padding: 8px 16px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 0.8em;
            z-index: 1000;
            min-height: 44px;
            display: flex;
            align-items: center;
        }
        .dashboard-link:hover {
            background: #2a3828;
        }

        /* Dropzone */
        #dropzone {
            border: 2px dashed #3a3828;
            border-radius: 8px;
            padding: clamp(15px, 5vw, 30px);
            text-align: center;
            cursor: pointer;
            width: 100%;
            max-width: 600px;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
        }

        #dropzone.over, #dropzone:hover {
            border-color: #c8a838;
            background: rgba(184, 152, 56, 0.04);
        }

        /* Image Queue */
        #imageQueue {
            width: 100%;
            max-width: 600px;
            background: #0c0c0a;
            border: 1px solid #2a2818;
            border-radius: 8px;
            padding: 10px;
            display: none;
        }

        .queue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 0.9em;
        }

        .queue-thumbnails {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 5px 0;
        }

        .queue-thumb {
            width: 50px;
            height: 50px;
            border: 1px solid #3a3828;
            border-radius: 4px;
            object-fit: cover;
        }

        .queue-count {
            background: #1a2818;
            color: #a0c080;
            padding: 2px 8px;
            border-radius: 12px;
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            width: 100%;
        }

        button {
            background: #141210;
            border: 1px solid #3a3828;
            color: #b8a878;
            padding: 10px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: clamp(0.7em, 3vw, 0.9em);
            transition: all 0.15s;
            min-height: 44px;
            min-width: 44px;
        }

        button:hover {
            background: #1e1c14;
            border-color: #c8a838;
            color: #e8d080;
        }

        button:disabled {
            opacity: 0.35;
            cursor: not-allowed;
        }

        button.go {
            background: #1a1808;
            border-color: #c8a838;
            color: #e8d080;
        }

        .toggle-btn {
            background: #1a1a14;
            border-color: #7a6840;
        }

        /* Parameter Controls */
        .param-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            width: 100%;
            background: #0c0c0a;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #2a2818;
        }

        label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: clamp(0.7em, 3vw, 0.8em);
            color: #7a6840;
            flex-wrap: wrap;
        }

        select, input[type=range] {
            background: #141210;
            border: 1px solid #3a3828;
            color: #b8a878;
            padding: 6px 10px;
            border-radius: 4px;
            font-family: inherit;
            font-size: 0.9em;
            min-height: 40px;
        }

        /* Canvas Panels */
        .panels {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
        }

        .panel {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            flex: 1 1 200px;
            min-width: 150px;
        }

        .plabel {
            font-size: 0.65em;
            color: #5a5440;
            letter-spacing: .09em;
            text-transform: uppercase;
        }

        canvas.view {
            border: 1px solid #2a2818;
            image-rendering: pixelated;
            width: 100%;
            height: auto;
            aspect-ratio: 1/1;
            max-width: 250px;
        }

        #evolved-panel {
            display: none;
        }

        /* Stats */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            background: #0c0c0a;
            border: 1px solid #2a2818;
            border-radius: 8px;
            padding: 15px;
            width: 100%;
            max-width: 800px;
        }

        .stat-item {
            text-align: center;
        }

        .sv {
            font-size: clamp(1em, 4vw, 1.3em);
            color: #e8d898;
            font-family: Georgia, serif;
        }

        .sl {
            font-size: 0.6em;
            color: #5a5440;
            letter-spacing: .06em;
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            max-width: 800px;
            height: 20px;
            background: #141210;
            border: 1px solid #3a3828;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #c8a838;
            width: 0%;
            transition: width 0.3s;
        }

        /* Fitness Curve */
        #crv {
            background: #0a0a08;
            border: 1px solid #2a2818;
            border-radius: 3px;
            width: 100%;
            max-width: 800px;
            height: 80px;
        }

        /* Export Box */
        .expbox {
            background: #0c0c0a;
            border: 1px solid #2a2818;
            border-radius: 6px;
            padding: 12px;
            width: 100%;
            max-width: 800px;
        }

        .expbox h3 {
            font-family: Georgia, serif;
            font-size: 0.9em;
            color: #7a6840;
            margin-bottom: 8px;
        }

        #pg-out {
            width: 100%;
            height: 120px;
            background: #080806;
            border: 1px solid #2a2818;
            color: #908860;
            padding: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.7em;
            resize: vertical;
        }

        .row {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }

        /* Batch Process Button */
        #batchProcessBtn {
            background: #1a2818;
            border-color: #a0c080;
            color: #d8f0c0;
            display: none;
        }

        /* Alert Area */
        #alert-area {
            width: 100%;
            max-width: 800px;
        }

        .alert {
            background: #2a2010;
            border: 1px solid #c8a838;
            color: #e8d080;
            padding: 8px;
            border-radius: 4px;
            margin: 5px 0;
            font-size: 0.8em;
        }

        /* Mobile Responsiveness */
        @media (max-width: 600px) {
            .panels {
                flex-direction: column;
                align-items: center;
            }
            
            .panel {
                width: 100%;
                max-width: 280px;
            }
            
            .controls {
                gap: 5px;
            }
            
            button {
                padding: 8px 10px;
                font-size: 0.75em;
            }
            
            .param-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            label {
                justify-content: space-between;
            }
            
            .dashboard-link {
                top: 10px;
                right: 10px;
                padding: 6px 12px;
                font-size: 0.7em;
            }
        }

        /* Touch Optimizations */
        @media (hover: none) and (pointer: coarse) {
            button, select, #dropzone {
                min-height: 48px;
            }
        }
    </style>
</head>
<body>
    <a href="dashboard.html" class="dashboard-link">üìä DASHBOARD</a>

    <h1>PIGMENT ‚Äî Evolutionary Painter</h1>
    <div class="sub">MULTI-IMAGE ¬∑ SEMI-TRANSPARENT POLYGONS ¬∑ REINFORCEMENT LEARNING</div>

    <!-- Drop Zone -->
    <div id="dropzone">
        <div style="font-size:2em; margin-bottom:8px">üé®</div>
        <div><strong>Drop up to 5 images here</strong> or click to choose</div>
        <div style="font-size:0.7em; margin-top:5px; opacity:0.7">JPG, PNG, GIF (max 5 files)</div>
    </div>
    <input type="file" id="fi" accept="image/*" multiple hidden>

    <!-- Image Queue -->
    <div id="imageQueue">
        <div class="queue-header">
            <span>üì¶ Image Queue</span>
            <span class="queue-count" id="queueCount">0/5</span>
        </div>
        <div class="queue-thumbnails" id="queueThumbnails"></div>
        <div class="row" style="margin-top:10px;">
            <button id="batchProcessBtn" class="go">‚ñ∂ Process All (5)</button>
            <button id="clearQueueBtn">üóëÔ∏è Clear</button>
        </div>
    </div>

    <!-- Main Controls -->
    <div class="controls">
        <button class="go" id="bstart" disabled onclick="doStart()">‚ñ∂ START</button>
        <button id="bpause" disabled onclick="doPause()">‚è∏ PAUSE</button>
        <button id="breset" disabled onclick="doReset()">‚Ü∫ RESET</button>
        <button id="bstep" disabled onclick="doStep()">‚è© STEP</button>
        <button id="toggleEvolved" class="toggle-btn" onclick="toggleEvolved()">üëÅÔ∏è Show Evolved</button>
    </div>

    <!-- Parameters -->
    <div class="param-controls">
        <label>Polygons
            <select id="selpoly">
                <option value="25">25</option>
                <option value="50" selected>50</option>
                <option value="100">100</option>
                <option value="200">200</option>
            </select>
        </label>
        <label>Speed
            <select id="selspd">
                <option value="5">Slow (5)</option>
                <option value="10">Medium (10)</option>
                <option value="20" selected>Normal (20)</option>
                <option value="40">Fast (40)</option>
            </select>
        </label>
        <label>Size
            <input type="range" id="rsize" min="2" max="9" step=".5" value="4" style="width:100px">
        </label>
    </div>

    <!-- Canvas Panels -->
    <div class="panels">
        <div class="panel">
            <div class="plabel">üéØ TARGET</div>
            <canvas class="view" id="cvt" width="200" height="200"></canvas>
        </div>
        <div class="panel" id="evolved-panel">
            <div class="plabel">üß¨ EVOLVED</div>
            <canvas class="view" id="cve" width="200" height="200"></canvas>
        </div>
        <div class="panel">
            <div class="plabel">üìä DIFF</div>
            <canvas class="view" id="cvd" width="200" height="200"></canvas>
        </div>
    </div>

    <!-- Stats -->
    <div class="stats">
        <div class="stat-item"><span class="sv" id="sg">0</span><span class="sl">GEN</span></div>
        <div class="stat-item"><span class="sv" id="sf">0.00%</span><span class="sl">FITNESS</span></div>
        <div class="stat-item"><span class="sv" id="si">0</span><span class="sl">IMPR</span></div>
        <div class="stat-item"><span class="sv" id="sr">0/s</span><span class="sl">SPEED</span></div>
        <div class="stat-item"><span class="sv" id="stime">0:00</span><span class="sl">TIME</span></div>
        <div class="stat-item"><span class="sv" id="sm">1.00</span><span class="sl">MUT</span></div>
    </div>

    <!-- Progress Bar -->
    <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
    </div>

    <!-- Fitness Curve -->
    <canvas id="crv"></canvas>

    <!-- Export Box -->
    <div class="expbox">
        <h3>üß¨ GENOME EXPORT</h3>
        <textarea id="pg-out" readonly placeholder="Genome will appear here..."></textarea>
        <div class="row">
            <button onclick="doExport()">üìÑ Export .pg</button>
            <button onclick="doCopy()">üìã Copy</button>
            <button onclick="doSaveImg()">üñºÔ∏è PNG</button>
            <button onclick="document.getElementById('pg-out').value=genPG()">üîÑ Refresh</button>
        </div>
    </div>

    <div id="alert-area"></div>

    <script>
        // ============================================
        // CONSTANTS & GLOBALS
        // ============================================
        const BASE_W = 200, BASE_H = 300;
        let W = BASE_W, H = BASE_H;
        let targetPx = null;
        let polys = [], bestPolys = [], bestErr = Infinity;
        let running = false, paused = false;
        let gen = 0, impr = 0, mutRate = 1.0;
        let rateT = { n: 0, t: performance.now() };
        let fitHist = [];
        let raf = null;
        let startTime = null;
        let frameCount = 0;

        // Image Queue
        let imageQueue = [];
        let currentImageIndex = 0;

        // Canvas
        const cvWork = document.createElement('canvas');
        const ctxWork = cvWork.getContext('2d');
        const cvT = document.getElementById('cvt');
        const ctxT = cvT.getContext('2d');
        const cvE = document.getElementById('cve');
        const ctxE = cvE.getContext('2d');
        const cvD = document.getElementById('cvd');
        const ctxD = cvD.getContext('2d');
        const crv = document.getElementById('crv');
        const crvCtx = crv.getContext('2d');
        const DS = 2;

        // ============================================
        // TOGGLE EVOLVED PANEL
        // ============================================
        function toggleEvolved() {
            const panel = document.getElementById('evolved-panel');
            const btn = document.getElementById('toggleEvolved');
            if (panel.style.display === 'none' || panel.style.display === '') {
                panel.style.display = 'flex';
                btn.textContent = 'üëÅÔ∏è Hide Evolved';
                localStorage.setItem('evolvedVisible', 'true');
            } else {
                panel.style.display = 'none';
                btn.textContent = 'üëÅÔ∏è Show Evolved';
                localStorage.setItem('evolvedVisible', 'false');
            }
        }

        // Load preference
        const savedVisibility = localStorage.getItem('evolvedVisible');
        if (savedVisibility === 'false') {
            document.getElementById('evolved-panel').style.display = 'none';
            document.getElementById('toggleEvolved').textContent = 'üëÅÔ∏è Show Evolved';
        }

        // ============================================
        // IMAGE QUEUE HANDLING
        // ============================================
        function updateQueueDisplay() {
            const queueDiv = document.getElementById('imageQueue');
            const thumbnailsDiv = document.getElementById('queueThumbnails');
            const countSpan = document.getElementById('queueCount');
            const batchBtn = document.getElementById('batchProcessBtn');

            if (imageQueue.length > 0) {
                queueDiv.style.display = 'block';
                countSpan.textContent = `${imageQueue.length}/5`;
                
                thumbnailsDiv.innerHTML = '';
                imageQueue.forEach((img, index) => {
                    const thumb = document.createElement('img');
                    thumb.src = img.src;
                    thumb.className = 'queue-thumb';
                    thumb.title = img.name;
                    thumb.onclick = () => {
                        // Load this image as target
                        loadImageFromElement(img);
                    };
                    thumbnailsDiv.appendChild(thumb);
                });

                batchBtn.style.display = 'inline-block';
                batchBtn.textContent = `‚ñ∂ Process All (${imageQueue.length})`;
            } else {
                queueDiv.style.display = 'none';
                batchBtn.style.display = 'none';
            }
        }

        function addToQueue(file) {
            if (imageQueue.length >= 5) {
                alert('Maximum 5 images allowed');
                return false;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    img.name = file.name;
                    imageQueue.push(img);
                    updateQueueDisplay();
                    showAlert(`‚úÖ Added: ${file.name}`);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
            return true;
        }

        function loadImageFromElement(img) {
            const ratio = img.height / img.width;
            W = BASE_W;
            H = Math.max(40, Math.round(W * ratio));
            if (H > 360) { H = 360; W = Math.round(H / ratio); }

            cvWork.width = W;
            cvWork.height = H;
            ctxWork.drawImage(img, 0, 0, W, H);
            targetPx = new Uint8ClampedArray(ctxWork.getImageData(0, 0, W, H).data);

            const dw = W * DS;
            const dh = H * DS;
            [cvT, cvE, cvD].forEach(c => { c.width = dw; c.height = dh; });
            ctxT.drawImage(cvWork, 0, 0, dw, dh);

            document.getElementById('bstart').disabled = false;
            document.getElementById('breset').disabled = false;
            document.getElementById('bstep').disabled = false;
            
            doReset();
            showAlert(`üéØ Loaded: ${img.name || 'image'}`);
        }

        async function processBatch() {
            if (imageQueue.length === 0) return;
            
            showAlert(`üîÑ Processing ${imageQueue.length} images...`);
            
            for (let i = 0; i < imageQueue.length; i++) {
                currentImageIndex = i;
                loadImageFromElement(imageQueue[i]);
                
                // Wait for evolution to make progress
                await new Promise(resolve => {
                    const checkProgress = setInterval(() => {
                        if (gen > 100) { // After 100 generations, move to next
                            clearInterval(checkProgress);
                            resolve();
                        }
                    }, 100);
                });
            }
            
            showAlert('‚úÖ Batch processing complete!');
        }

        // ============================================
        // CORE EVOLUTION FUNCTIONS
        // ============================================
        function rPoly() {
            const sz = W * (0.05 + Math.random() * parseFloat(document.getElementById('rsize').value) * 0.06);
            const cx = Math.random() * W;
            const cy = Math.random() * H;
            const pts = [];
            for (let i = 0; i < 3; i++) {
                const a = (i / 3) * Math.PI * 2 + Math.random() * 1.2;
                const r = sz * (0.4 + Math.random() * 0.9);
                pts.push([cx + Math.cos(a) * r, cy + Math.sin(a) * r]);
            }
            return { pts, r: Math.random() * 255 | 0, g: Math.random() * 255 | 0, b: Math.random() * 255 | 0, a: (20 + Math.random() * 100) | 0 };
        }

        function clp(x, y) {
            return [Math.max(-W * .1, Math.min(W * 1.1, x)), Math.max(-H * .1, Math.min(H * 1.1, y))];
        }

        function gauss(s) {
            const u1 = Math.random(), u2 = Math.random();
            return s * Math.sqrt(-2 * Math.log(u1 + 1e-9)) * Math.cos(2 * Math.PI * u2);
        }

        function mutPoly(p, mr) {
            const q = { pts: p.pts.map(pt => [...pt]), r: p.r, g: p.g, b: p.b, a: p.a };
            const c = Math.random();
            if (c < 0.28) {
                const vi = Math.random() * q.pts.length | 0;
                const s = W * 0.05 * mr;
                q.pts[vi] = clp(q.pts[vi][0] + gauss(s), q.pts[vi][1] + gauss(s));
            } else if (c < 0.46) {
                const dx = gauss(W * .04 * mr), dy = gauss(H * .04 * mr);
                q.pts = q.pts.map(([x, y]) => clp(x + dx, y + dy));
            } else if (c < 0.62) {
                const ch = ['r', 'g', 'b'][Math.random() * 3 | 0];
                q[ch] = Math.max(0, Math.min(255, q[ch] + gauss(18 * mr) | 0));
            } else if (c < 0.78) {
                q.a = Math.max(6, Math.min(165, q.a + gauss(10 * mr) | 0));
            } else if (c < 0.90) {
                const sc = 0.82 + Math.random() * 0.40;
                const cx = q.pts.reduce((s, p) => s + p[0], 0) / q.pts.length;
                const cy = q.pts.reduce((s, p) => s + p[1], 0) / q.pts.length;
                q.pts = q.pts.map(([x, y]) => clp(cx + (x - cx) * sc, cy + (y - cy) * sc));
            } else {
                return rPoly();
            }
            return q;
        }

        function render(ps, ctx, w, h) {
            ctx.clearRect(0, 0, w, h);
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, w, h);
            for (const p of ps) {
                ctx.beginPath();
                ctx.moveTo(p.pts[0][0], p.pts[0][1]);
                for (let i = 1; i < p.pts.length; i++) ctx.lineTo(p.pts[i][0], p.pts[i][1]);
                ctx.closePath();
                ctx.fillStyle = `rgba(${p.r},${p.g},${p.b},${p.a / 255})`;
                ctx.fill();
            }
        }

        function calcErr(id) {
            const d = id.data, t = targetPx;
            let e = 0;
            for (let i = 0; i < d.length; i += 4) {
                const dr = d[i] - t[i], dg = d[i + 1] - t[i + 1], db = d[i + 2] - t[i + 2];
                e += dr * dr + dg * dg + db * db;
            }
            return e;
        }

        function fitPct(e) {
            return Math.max(0, 100 * (1 - e / (255 * 255 * 3 * W * H)));
        }

        function evolveStep() {
            const pc = parseInt(document.getElementById('selpoly').value);
            const sp = parseInt(document.getElementById('selspd').value);
            for (let s = 0; s < sp; s++) {
                const idx = Math.random() * polys.length | 0;
                const candidate = polys.slice();
                candidate[idx] = mutPoly(polys[idx], mutRate);
                cvWork.width = W;
                cvWork.height = H;
                render(candidate, ctxWork, W, H);
                const err = calcErr(ctxWork.getImageData(0, 0, W, H));
                if (err < bestErr) {
                    polys = candidate;
                    bestPolys = candidate.map(p => ({ ...p, pts: p.pts.map(pt => [...pt]) }));
                    bestErr = err;
                    impr++;
                    mutRate = Math.max(0.18, mutRate * 0.9999);
                } else {
                    mutRate = Math.min(2.2, mutRate * 1.00005);
                }
                gen++;
                rateT.n++;
            }
            if (polys.length < pc && gen % 900 === 0) {
                polys.push(rPoly());
                bestPolys = polys.map(p => ({ ...p, pts: p.pts.map(pt => [...pt]) }));
            }
        }

        function frame() {
            if (!running || paused) { raf = null; return; }
            evolveStep();
            frameCount++;
            if (frameCount % 4 === 0) updateDisplay();
            raf = requestAnimationFrame(frame);
        }

        function updateDisplay() {
            if (!targetPx) return;
            
            cvWork.width = W;
            cvWork.height = H;
            render(bestPolys, ctxWork, W, H);
            const dw = W * DS, dh = H * DS;
            ctxE.drawImage(cvWork, 0, 0, dw, dh);

            const ev = ctxWork.getImageData(0, 0, W, H);
            const diff = ctxD.createImageData(W, H);
            for (let i = 0; i < ev.data.length; i += 4) {
                diff.data[i] = Math.min(255, Math.abs(ev.data[i] - targetPx[i]) * 4);
                diff.data[i + 1] = Math.min(255, Math.abs(ev.data[i + 1] - targetPx[i + 1]) * 4);
                diff.data[i + 2] = Math.min(255, Math.abs(ev.data[i + 2] - targetPx[i + 2]) * 4);
                diff.data[i + 3] = 255;
            }
            const tmp = document.createElement('canvas');
            tmp.width = W;
            tmp.height = H;
            tmp.getContext('2d').putImageData(diff, 0, 0);
            ctxD.drawImage(tmp, 0, 0, dw, dh);

            const fp = fitPct(bestErr);
            document.getElementById('sg').textContent = gen.toLocaleString();
            document.getElementById('sf').textContent = fp.toFixed(2) + '%';
            document.getElementById('si').textContent = impr.toLocaleString();
            document.getElementById('sm').textContent = mutRate.toFixed(3);

            if (startTime) {
                const elapsed = (performance.now() - startTime) / 1000;
                const mins = Math.floor(elapsed / 60);
                const secs = Math.floor(elapsed % 60);
                document.getElementById('stime').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
            }

            const now = performance.now(), dt = (now - rateT.t) / 1000;
            if (dt > 0.5) {
                document.getElementById('sr').textContent = (rateT.n / dt | 0) + '/s';
                rateT = { n: 0, t: now };
            }

            fitHist.push(fp);
            if (fitHist.length > 300) fitHist.shift();
            drawCurve();

            // Update progress bar
            document.getElementById('progressFill').style.width = fp + '%';

            if (impr > 0 && impr % 1000 === 0) document.getElementById('pg-out').value = genPG();
        }

        function drawCurve() {
            const cw = crv.width, ch = crv.height;
            crvCtx.clearRect(0, 0, cw, ch);
            if (fitHist.length < 2) return;
            const mx = Math.max(...fitHist), mn = Math.min(...fitHist), rng = Math.max(mx - mn, 0.5);
            crvCtx.strokeStyle = '#c0a030';
            crvCtx.lineWidth = 1.5;
            crvCtx.beginPath();
            for (let i = 0; i < fitHist.length; i++) {
                const x = (i / (fitHist.length - 1)) * cw;
                const y = ch - ((fitHist[i] - mn) / rng) * (ch - 10) - 5;
                i === 0 ? crvCtx.moveTo(x, y) : crvCtx.lineTo(x, y);
            }
            crvCtx.stroke();
            crvCtx.fillStyle = '#3a3828';
            crvCtx.font = '10px Courier New';
            crvCtx.fillText(mx.toFixed(1) + '%', 4, 11);
            crvCtx.fillText(mn.toFixed(1) + '%', 4, ch - 8);
        }

        // ============================================
        // CONTROLS
        // ============================================
        function doStart() {
            if (!targetPx) return;
            running = true;
            paused = false;
            startTime = startTime || performance.now();
            document.getElementById('bstart').disabled = true;
            document.getElementById('bpause').disabled = false;
            if (!raf) raf = requestAnimationFrame(frame);
        }

        function doPause() {
            paused = !paused;
            document.getElementById('bpause').textContent = paused ? '‚ñ∂ Resume' : '‚è∏ Pause';
            if (!paused && !raf) raf = requestAnimationFrame(frame);
        }

        function doStep() {
            if (!targetPx || !paused) return;
            evolveStep();
            updateDisplay();
        }

        function doReset() {
            if (raf) {
                cancelAnimationFrame(raf);
                raf = null;
            }
            running = false;
            paused = false;
            startTime = null;

            const pc = parseInt(document.getElementById('selpoly').value);
            polys = Array.from({ length: pc }, () => rPoly());
            bestPolys = polys.map(p => ({ ...p, pts: p.pts.map(pt => [...pt]) }));

            cvWork.width = W;
            cvWork.height = H;
            render(bestPolys, ctxWork, W, H);
            bestErr = calcErr(ctxWork.getImageData(0, 0, W, H));

            gen = 0;
            impr = 0;
            mutRate = 1.0;
            fitHist = [];
            rateT = { n: 0, t: performance.now() };

            document.getElementById('bstart').disabled = false;
            document.getElementById('bpause').disabled = true;
            document.getElementById('bpause').textContent = '‚è∏ Pause';
            document.getElementById('pg-out').value = '';

            updateDisplay();
        }

        // ============================================
        // GENOME EXPORT
        // ============================================
        function genPG() {
            const fp = fitPct(bestErr);
            const lines = [
                `-- PIGMENT v3 Evolutionary Genome`,
                `-- Gen: ${gen.toLocaleString()}  Fitness: ${fp.toFixed(2)}%  Polygons: ${bestPolys.length}`,
                `-- Algorithm: Roger Alsing hill-climbing mutation`, ``,
                `canvas { format: portrait  title: "Evolved Painting"  artist: "PIGMENT v3"  date: "${new Date().getFullYear()}" }`, ``,
                `palette {`,
            ];
            const step = Math.max(1, bestPolys.length / 16 | 0);
            const palNames = [];
            for (let i = 0; i < bestPolys.length; i += step) {
                const p = bestPolys[i];
                const h = p.r.toString(16).padStart(2, '0') + p.g.toString(16).padStart(2, '0') + p.b.toString(16).padStart(2, '0');
                const nm = `p${palNames.length}`;
                palNames.push(nm);
                lines.push(`  ${nm.padEnd(8)}: #${h}`);
            }
            lines.push(`}`, '', `layer evolved {`);
            for (let i = 0; i < bestPolys.length; i++) {
                const p = bestPolys[i];
                const h = p.r.toString(16).padStart(2, '0') + p.g.toString(16).padStart(2, '0') + p.b.toString(16).padStart(2, '0');
                const op = (p.a / 255).toFixed(3);
                const pts = p.pts.map(([x, y]) => `${(x / W).toFixed(3)},${(y / H).toFixed(3)}`).join(' ');
                lines.push(`  -- [${pts}]  Œ±=${op}`);
                lines.push(`  zone poly-${i} { color: #${h}  opacity: ${op} }`);
            }
            lines.push(`}`);
            return lines.join('\n');
        }

        function doExport() {
            const t = genPG();
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([t], { type: 'text/plain' }));
            a.download = `evolved_gen${gen}.pg`;
            a.click();
            document.getElementById('pg-out').value = t;
        }

        function doCopy() {
            navigator.clipboard.writeText(genPG()).catch(() => { });
            document.getElementById('pg-out').value = genPG();
        }

        function doSaveImg() {
            cvWork.width = W * 4;
            cvWork.height = H * 4;
            render(bestPolys, ctxWork, W * 4, H * 4);
            const a = document.createElement('a');
            a.href = cvWork.toDataURL('image/png');
            a.download = `evolved_gen${gen}.png`;
            a.click();
        }

        function showAlert(msg) {
            const alertArea = document.getElementById('alert-area');
            const alert = document.createElement('div');
            alert.className = 'alert';
            alert.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            alertArea.appendChild(alert);
            setTimeout(() => alert.remove(), 3000);
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        document.getElementById('fi').onchange = (e) => {
            const files = Array.from(e.target.files);
            if (files.length > 5) {
                alert('Maximum 5 images allowed');
                return;
            }
            imageQueue = [];
            files.forEach(f => addToQueue(f));
        };

        const dz = document.getElementById('dropzone');
        dz.addEventListener('dragover', e => {
            e.preventDefault();
            dz.classList.add('over');
        });
        dz.addEventListener('dragleave', () => dz.classList.remove('over'));
        dz.addEventListener('drop', e => {
            e.preventDefault();
            dz.classList.remove('over');
            const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
            if (files.length > 5) {
                alert('Maximum 5 images allowed');
                return;
            }
            imageQueue = [];
            files.forEach(f => addToQueue(f));
        });

        document.getElementById('batchProcessBtn').addEventListener('click', processBatch);
        document.getElementById('clearQueueBtn').addEventListener('click', () => {
            imageQueue = [];
            updateQueueDisplay();
        });

        // Curve resize
        function rCrv() {
            crv.width = Math.min(800, window.innerWidth - 30);
            crv.height = 80;
            drawCurve();
        }
        rCrv();
        window.addEventListener('resize', rCrv);
    </script>
</body>
</html>