<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PIGMENT ‚Äî Learning Dashboard</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Courier New',monospace;}
        body{background:#080806;color:#c0b898;padding:20px;}
        .header{text-align:center;margin-bottom:30px;}
        h1{font-family:Georgia,serif;color:#e8d898;font-size:2.5em;}
        .sub{color:#5a5440;margin-top:5px;}
        
        .dashboard-grid{
            display:grid;
            grid-template-columns:repeat(auto-fit,minmax(400px,1fr));
            gap:20px;
            max-width:1600px;
            margin:0 auto;
        }
        
        .card{
            background:#0c0c0a;
            border:1px solid #2a2818;
            border-radius:8px;
            padding:20px;
        }
        
        .card h2{
            color:#7a6840;
            font-size:1.2em;
            margin-bottom:15px;
            border-bottom:1px solid #2a2818;
            padding-bottom:5px;
        }
        
        .stat-row{
            display:flex;
            justify-content:space-between;
            padding:8px 0;
            border-bottom:1px solid #1a1810;
        }
        
        .stat-label{color:#7a7460;}
        .stat-value{color:#e8d898;font-weight:bold;}
        
        .success-bar{
            height:20px;
            background:#1a1810;
            border-radius:10px;
            overflow:hidden;
            margin:5px 0;
        }
        
        .success-fill{
            height:100%;
            background:#c8a838;
            transition:width 0.3s;
        }
        
        .mutation-grid{
            display:grid;
            grid-template-columns:repeat(2,1fr);
            gap:10px;
            margin-top:15px;
        }
        
        .mutation-card{
            background:#141210;
            border:1px solid #2a2818;
            border-radius:4px;
            padding:10px;
        }
        
        .mutation-name{
            color:#c0b080;
            font-weight:bold;
        }
        
        .percentage{
            font-size:1.3em;
            color:#e8d898;
        }
        
        .badge{
            display:inline-block;
            padding:2px 8px;
            border-radius:12px;
            font-size:0.8em;
            background:#1a2810;
            color:#a0c080;
        }
        
        .learning-progress{
            margin-top:20px;
            padding:15px;
            background:#1a1810;
            border-radius:4px;
        }
        
        .footer{
            text-align:center;
            margin-top:30px;
            color:#5a5440;
            font-size:0.9em;
        }
        
        #last-update{
            color:#7a6840;
            font-size:0.9em;
        }
        
        .error-message{
            color:#c06060;
            text-align:center;
            margin:10px;
            padding:10px;
            background:#1a1010;
            border-radius:4px;
            display:none;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üß† PIGMENT LEARNING DASHBOARD</h1>
        <div class="sub">REAL-TIME AI LEARNING METRICS ¬∑ SUPABASE ML ¬∑ REINFORCEMENT LEARNING</div>
    </div>

    <div id="error-message" class="error-message"></div>

    <div class="dashboard-grid">
        <!-- Evolution Stats Card -->
        <div class="card">
            <h2>üìà EVOLUTION STATS</h2>
            <div id="evolution-stats">
                <div class="stat-row"><span class="stat-label">Training Samples:</span> <span class="stat-value" id="total-samples">0</span></div>
                <div class="stat-row"><span class="stat-label">Q-Learning States:</span> <span class="stat-value" id="q-states">0</span></div>
                <div class="stat-row"><span class="stat-label">Embeddings Stored:</span> <span class="stat-value" id="embeddings">0</span></div>
                <div class="stat-row"><span class="stat-label">Avg Improvement:</span> <span class="stat-value" id="avg-improve">--</span></div>
            </div>
            <div class="learning-progress">
                <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
                    <span>Learning Progress</span>
                    <span id="learning-phase">Early Stage</span>
                </div>
                <div class="success-bar"><div class="success-fill" id="learning-bar" style="width:0%"></div></div>
            </div>
        </div>

        <!-- Mutation Success Rates Card -->
        <div class="card">
            <h2>üéØ MUTATION SUCCESS RATES</h2>
            <div id="mutation-rates"></div>
        </div>

        <!-- RL Q-Table Preview Card -->
        <div class="card">
            <h2>üîÆ Q-TABLE INSIGHTS</h2>
            <div id="q-insights">
                <div style="color:#7a7460;text-align:center;padding:20px;">‚è≥ Q-Table is learning...</div>
            </div>
            <div style="margin-top:15px;">
                <div class="stat-row"><span class="stat-label">Best Action Overall:</span> <span class="stat-value" id="best-action">--</span></div>
                <div class="stat-row"><span class="stat-label">Exploration Rate:</span> <span class="stat-value">20%</span></div>
                <div class="stat-row"><span class="stat-label">Learning Rate:</span> <span class="stat-value">0.1</span></div>
            </div>
        </div>

        <!-- Stage-Based Strategy Card -->
        <div class="card">
            <h2>‚ö° STAGE-BASED STRATEGY</h2>
            <div id="stage-strategy">
                <div style="color:#7a7460;text-align:center;padding:20px;">‚è≥ Collecting stage data...</div>
            </div>
        </div>
    </div>

    <div class="footer">
        <span id="last-update"></span><br>
        PIGMENT ¬∑ Self-Learning Evolutionary Art
    </div>

    <script>
        const SUPABASE_URL = 'https://slfxwkvhomomdcqpkfqp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNsZnh3a3Zob21vbWRjcXBrZnFwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNzQxNzQsImV4cCI6MjA4Njk1MDE3NH0.ThDVJzCPooZCwFt68Aw608t9Dmnt-cWgxlYy9nPRhpY';

        async function loadDashboardData() {
            try {
                document.getElementById('last-update').innerHTML = 'Loading...';
                
                // Get mutation stats
                const mutationResponse = await fetch(`${SUPABASE_URL}/rest/v1/training_data?select=operator_used,mutation_success,parent_fitness,offspring_fitness`, {
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'apikey': SUPABASE_ANON_KEY
                    }
                });
                
                if (!mutationResponse.ok) {
                    throw new Error(`HTTP error! status: ${mutationResponse.status}`);
                }
                
                const trainingData = await mutationResponse.json();
                
                // Get Q-table stats
                const qResponse = await fetch(`${SUPABASE_URL}/rest/v1/rl_q_table?select=*`, {
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'apikey': SUPABASE_ANON_KEY
                    }
                });
                const qData = await qResponse.json();
                
                // Get embedding stats
                const embedResponse = await fetch(`${SUPABASE_URL}/rest/v1/image_embeddings?select=*`, {
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'apikey': SUPABASE_ANON_KEY
                    }
                });
                const embedData = await embedResponse.json();

                // Update UI with data
                document.getElementById('total-samples').innerHTML = trainingData.length;
                document.getElementById('q-states').innerHTML = qData.length;
                document.getElementById('embeddings').innerHTML = embedData.length;
                
                // Calculate average improvement
                let totalImprovement = 0;
                let improvementCount = 0;
                trainingData.forEach(row => {
                    if (row.offspring_fitness && row.parent_fitness) {
                        totalImprovement += (row.offspring_fitness - row.parent_fitness);
                        improvementCount++;
                    }
                });
                const avgImprove = improvementCount > 0 ? (totalImprovement / improvementCount * 100).toFixed(3) + '%' : '--';
                document.getElementById('avg-improve').innerHTML = avgImprove;

                // Calculate mutation success rates
                const mutationStats = {};
                trainingData.forEach(row => {
                    const op = row.operator_used || 'unknown';
                    if (!mutationStats[op]) {
                        mutationStats[op] = { attempts: 0, successes: 0 };
                    }
                    mutationStats[op].attempts++;
                    if (row.mutation_success) {
                        mutationStats[op].successes++;
                    }
                });

                // Display mutation rates
                const ratesContainer = document.getElementById('mutation-rates');
                ratesContainer.innerHTML = '';
                
                if (Object.keys(mutationStats).length > 0) {
                    Object.entries(mutationStats)
                        .map(([op, stats]) => ({
                            operator: op,
                            attempts: stats.attempts,
                            successes: stats.successes,
                            rate: stats.attempts > 0 ? (stats.successes / stats.attempts * 100).toFixed(1) : '0'
                        }))
                        .sort((a, b) => b.rate - a.rate)
                        .forEach(r => {
                            const card = document.createElement('div');
                            card.className = 'mutation-card';
                            card.innerHTML = `
                                <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
                                    <span class="mutation-name">${r.operator}</span>
                                    <span class="percentage">${r.rate}%</span>
                                </div>
                                <div class="success-bar">
                                    <div class="success-fill" style="width:${r.rate}%"></div>
                                </div>
                                <div style="display:flex;justify-content:space-between;margin-top:5px;font-size:0.8em;color:#7a7460;">
                                    <span>${r.successes} successes</span>
                                    <span>${r.attempts} attempts</span>
                                </div>
                            `;
                            ratesContainer.appendChild(card);
                        });
                } else {
                    ratesContainer.innerHTML = '<div style="color:#7a7460;text-align:center;padding:20px;">No mutation data yet</div>';
                }

                // Update learning phase
                const samples = trainingData.length;
                let phase = 'Early Stage';
                let progress = 0;
                if (samples < 100) { phase = 'Early Stage'; progress = 25; }
                else if (samples < 500) { phase = 'Learning'; progress = 50; }
                else if (samples < 1000) { phase = 'Refining'; progress = 75; }
                else { phase = 'Mature'; progress = 100; }
                
                document.getElementById('learning-phase').innerHTML = phase;
                document.getElementById('learning-bar').style.width = progress + '%';

                // Update Q-insights
                const qInsights = document.getElementById('q-insights');
                if (qData.length > 0) {
                    qInsights.innerHTML = `<div style="color:#a09870;">${qData.length} learned states in Q-table</div>`;
                    
                    // Find best action from Q-table
                    // This is simplified - you could add more complex analysis
                    document.getElementById('best-action').innerHTML = 'learning...';
                } else {
                    qInsights.innerHTML = '<div style="color:#7a7460;text-align:center;padding:20px;">‚è≥ Q-Table is learning...</div>';
                }

                // Find best action from mutation data
                if (Object.keys(mutationStats).length > 0) {
                    const best = Object.entries(mutationStats)
                        .map(([op, stats]) => ({ 
                            op, 
                            rate: stats.attempts > 0 ? stats.successes / stats.attempts : 0 
                        }))
                        .sort((a, b) => b.rate - a.rate)[0];
                    document.getElementById('best-action').innerHTML = best.op;
                }

                document.getElementById('last-update').innerHTML = `Auto-updates every 30s ¬∑ Last: ${new Date().toLocaleTimeString()}`;
                
            } catch (err) {
                console.error('Dashboard error:', err);
                document.getElementById('error-message').style.display = 'block';
                document.getElementById('error-message').innerHTML = 'Error loading data: ' + err.message;
                document.getElementById('last-update').innerHTML = 'Error - check console';
            }
        }

        // Load immediately and then every 30 seconds
        loadDashboardData();
        setInterval(loadDashboardData, 30000);
    </script>
</body>
</html>